<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://sitodo-example.herokuapp.com/bootcamp/day-2/update-data-model/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>One of Many Lists - Sitodo</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "One of Many Lists";
        var mkdocs_page_input_path = "bootcamp\\day-2\\update-data-model.md";
        var mkdocs_page_url = "/bootcamp/day-2/update-data-model/";
      </script>
    
    <script src="../../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> Sitodo
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Home</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../..">Course Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Day One</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../day-1/init-spring/">Initialise Project</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../day-1/hello-tdd/">Hello, TDD</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../day-1/qa-automation/">Deployment Automation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../day-1/basic-list/">Create a Basic Todo List</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../day-1/end-day-1/">Recap</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Day Two</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../test-automation/">Test Automation</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">One of Many Lists</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#data-persistence-layer">Data Persistence Layer</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#repository-layer">Repository Layer</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#service-layer">Service Layer</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#controller">Controller</a>
    </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">Sitodo</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Day Two &raquo;</li>
      <li>One of Many Lists</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="one-of-many-lists">One of Many Lists</h1>
<p>Today you will update the application by making the user able to create multiple lists each time they open the app.
At the same time, you will practice a Git workflow called <strong>Feature Branch</strong> workflow.</p>
<p>First, make sure your local Git repository has the same history as the remote Git repository on GitHub.
If you have any Git commits that have not been pushed to GitHub, please commit them now.
Similarly, if you made changes on GitHub, ensure the Git commit history is pulled into your local Git repository.</p>
<pre><code class="language-shell"># Push commits
git push origin main
# Pull commits from remote Git repository into the currently active branch
git pull origin main
</code></pre>
<p>According to Feature Branch workflow, any new changes to the codebase should be done in a separate branch from the main branch.
Once the changes have been tested, the branch is merged into the main branch.
This is to ensure any ongoing development will not break the application that built from the main branch.</p>
<h2 id="data-persistence-layer">Data Persistence Layer</h2>
<p>Let us start from the data persistence layer.
Open a shell (or terminal in the IDE) and create a new branch named <code>update-data-model</code> using <code>git branch</code> and <code>git checkout</code> commands:</p>
<pre><code class="language-shell">git branch update-data-model
git checkout update-data-model
# Or shorter form:
git checkout -b update-data-model
</code></pre>
<p>Open <code>model</code> package in the production code and update <code>TodoItem</code> class with following code snippets:</p>
<pre><code class="language-java">// TodoItem.java
import lombok.Data;
import lombok.NoArgsConstructor;

import javax.persistence.*;

@Data
@Entity
@NoArgsConstructor
public class TodoItem {

    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE)
    private Long id;

    @Column(nullable = false)
    private String title;

    @Column
    private Boolean finished = Boolean.FALSE;

    public TodoItem(String title) {
        this.title = title;
    }

    public TodoItem(Long id, String title) {
        this.id = id;
        this.title = title;
    }
}
</code></pre>
<p>Then, add a new model class named <code>TodoList</code> in the same <code>model</code> package as <code>TodoItem</code> class:</p>
<pre><code class="language-java">import lombok.Data;
import lombok.NoArgsConstructor;

import javax.persistence.*;
import java.util.List;

@Data
@Entity
@NoArgsConstructor
public class TodoList {

    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE)
    private Long id;

    @OneToMany(cascade = {CascadeType.PERSIST, CascadeType.MERGE})
    private List&lt;TodoItem&gt; items;

    public TodoList(List&lt;TodoItem&gt; items) {
        this.items= items;
    }

    public void addTodoItem(TodoItem item) {
        items.add(item);
    }
}
</code></pre>
<p>Based on the new data model, all instances of <code>TodoItem</code> will be associated to a <code>TodoList</code>.
Or in other words, a <code>TodoList</code> will have one-to-many relationship to <code>TodoItem</code>.
Certainly, this will require you to update the code across every layer.</p>
<h2 id="repository-layer">Repository Layer</h2>
<p>Open <code>repository</code> package in the production code and update <code>TodoListRepository</code> class with following code snippets:</p>
<pre><code class="language-java">import org.springframework.data.repository.CrudRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface TodoListRepository extends CrudRepository&lt;TodoList, Long&gt; {
}
</code></pre>
<p>Based on the change above, <code>TodoItem</code> was replaced with <code>TodoList</code>.
All queries for querying todo items will use the one-to-many relationship mapping possessed by <code>TodoList</code>.</p>
<h2 id="service-layer">Service Layer</h2>
<p>Open <code>service</code> package in the production code and update <code>TodoListService</code> class with following code snippets:</p>
<pre><code class="language-java">import com.example.sitodo.model.TodoItem;
import com.example.sitodo.model.TodoList;
import com.example.sitodo.repository.TodoListRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.NoSuchElementException;
import java.util.Optional;

@Service
public class TodoListService {

    private static final Logger LOG = LoggerFactory.getLogger(TodoListService.class);
    private static final String TODO_LIST_DOES_NOT_EXIST_FMT = &quot;TodoList(id=%d) does not exist&quot;;

    private TodoListRepository todoListRepository;

    @Autowired
    public void setTodoListRepository(TodoListRepository todoListRepository) {
        this.todoListRepository = todoListRepository;
    }

    public TodoList getTodoListById(Long id) throws NoSuchElementException {
        Optional&lt;TodoList&gt; result = todoListRepository.findById(id);

        return result.get();
    }

    public TodoList addTodoItem(TodoItem todoItem) {
        TodoList list = new TodoList(List.of(todoItem));

        return todoListRepository.save(list);
    }

    public TodoList addTodoItem(Long id, TodoItem todoItem) throws NoSuchElementException {
        Optional&lt;TodoList&gt; result = todoListRepository.findById(id);

        TodoList foundList = result.get();
        foundList.addTodoItem(todoItem);

        return todoListRepository.save(foundList);
    }

    public TodoList updateTodoItem(Long listId, Long itemId, Boolean status) throws NoSuchElementException {
        Optional&lt;TodoList&gt; result = todoListRepository.findById(listId);

        // TODO: Implement me!
        return null;
    }

    public Boolean deleteTodoItem(Long listId, Long itemId) throws NoSuchElementException {
        Optional&lt;TodoList&gt; result = todoListRepository.findById(listId);

        // TODO: Implement me!
        return Boolean.FALSE;
    }
}
</code></pre>
<p>Update the test cases for <code>TodoListService</code> in the test code:</p>
<pre><code class="language-java">// TodoListServiceTest.java
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Tag;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;

import java.util.*;
import java.util.stream.IntStream;

import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.Matchers.*;
import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyLong;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

@SpringBootTest
class TodoListServiceTest {

    @Autowired
    private TodoListService todoListService;

    @MockBean
    private TodoListRepository todoListRepository;

    @Test
    @DisplayName(&quot;Given an existing ID, getTodoListById should return an existing list&quot;)
    void getTodoListById_ok() {
        TodoList todoList = createTodoList(&quot;Buy milk&quot;);
        when(todoListRepository.findById(anyLong())).thenReturn(Optional.of(todoList));

        TodoList savedList = todoListService.getTodoListById(1L);

        assertFalse(savedList.getItems().isEmpty());
    }

    @Test
    @DisplayName(&quot;Suppose the list does not exist, getTodoListById should throw an exception&quot;)
    void getTodoListById_exception() {
        when(todoListRepository.findById(anyLong())).thenReturn(Optional.empty());

        assertThrows(NoSuchElementException.class, () -&gt; todoListService.getTodoListById(1L));
    }

    @Test
    @DisplayName(&quot;Given a new todo item, addTodoItem should save the item into a new list&quot;)
    void addTodoItem_ok() {
        TodoItem todoItem = new TodoItem(&quot;Buy milk&quot;);
        when(todoListRepository.save(any(TodoList.class))).thenReturn(new TodoList(List.of(todoItem)));

        TodoList savedList = todoListService.addTodoItem(todoItem);
        TodoItem savedTodoItem = savedList.getItems().get(0);

        assertFalse(savedList.getItems().isEmpty());
        assertEquals(&quot;Buy milk&quot;, savedTodoItem.getTitle());
    }

    @Test
    @DisplayName(&quot;Given a todo item, addTodoItem should save the item into an existing list&quot;)
    void addTodoItem_existingList_ok() {
        TodoList list = createTodoList(&quot;Buy milk&quot;);
        when(todoListRepository.findById(anyLong())).thenReturn(Optional.of(list));

        todoListService.addTodoItem(1L, new TodoItem(&quot;Touch grass&quot;));

        assertEquals(2, list.getItems().size(), &quot;The numbers of items in the list: &quot; + list.getItems().size());
    }

    @Test
    @DisplayName(&quot;Suppose the list does not exist, addTodoItem should throw an exception&quot;)
    void addTodoItem_existingList_exception() {
        when(todoListRepository.findById(anyLong())).thenReturn(Optional.empty());

        assertThrows(NoSuchElementException.class, () -&gt; todoListService.addTodoItem(1L, new TodoItem(&quot;Buy milk&quot;)));
    }

    @Test
    @DisplayName(&quot;Given an existing list with an item, updateTodoItem should update the status of an item&quot;)
    void updateTodoItem_ok() {
        // TODO: Implement me!
    }

    @Test
    @DisplayName(&quot;Suppose the list does not exist, updateTodoItem should throw an exception&quot;)
    void updateTodoItem_exception() {
        when(todoListRepository.findById(anyLong())).thenReturn(Optional.empty());

        assertThrows(NoSuchElementException.class, () -&gt; todoListService.updateTodoItem(1L, 2L, true));
    }

    // TODO: Create tests for deleteTodoItem

    private TodoList createTodoList(String... items) {
        TodoList list = new TodoList(new ArrayList&lt;&gt;());

        Arrays.stream(items)
            .map(TodoItem::new)
            .forEach(list::addTodoItem);

        return list;
    }
}
</code></pre>
<p>Notice that there are several methods and TODO comments that need to be resolved.
Using your experience from previous day, try to implement the missing tests and functionality in the service layer.</p>
<h2 id="controller">Controller</h2>
<p>Open <code>controller</code> package in the production code and update <code>TodoListController</code> class with following code snippets:</p>
<pre><code class="language-java">// TodoListController.java
import com.example.sitodo.model.TodoItem;
import com.example.sitodo.model.TodoList;
import com.example.sitodo.service.TodoListService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;

import java.util.NoSuchElementException;

@Controller
public class TodoListController {

    private static final Logger LOG = LoggerFactory.getLogger(TodoListController.class);

    private TodoListService todoListService;

    @Autowired
    public void setTodoListService(TodoListService todoListService) {
        this.todoListService = todoListService;
    }

    @GetMapping(&quot;/list&quot;)
    public String showList(TodoList todoList, Model model) {
        model.addAttribute(&quot;todoList&quot;, todoList);

        return &quot;list&quot;;
    }

    @GetMapping(&quot;/list/{id}&quot;)
    public String showList(@PathVariable(&quot;id&quot;) Long id, Model model) {
        TodoList foundTodoList = todoListService.getTodoListById(id);

        model.addAttribute(&quot;todoList&quot;, foundTodoList);

        return &quot;list&quot;;
    }

    @PostMapping(&quot;/list&quot;)
    public String newItem(@RequestParam(&quot;item_text&quot;) String item) {
        TodoList saved = todoListService.addTodoItem(new TodoItem(item));

        return redirectToList(saved.getId());
    }

    @PostMapping(&quot;/list/{id}&quot;)
    public String newItem(@PathVariable(&quot;id&quot;) Long id,
                          @RequestParam(&quot;item_text&quot;) String item) {
        TodoList saved = todoListService.addTodoItem(id, new TodoItem(item));

        return redirectToList(saved.getId());
    }

    @GetMapping(&quot;/list/{list_id}/update/{item_id}&quot;)
    public String updateItem(@PathVariable(&quot;list_id&quot;) Long listId,
                             @PathVariable(&quot;item_id&quot;) Long itemId,
                             @RequestParam(&quot;finished&quot;) Boolean finished) {
        return &quot;&quot;; // TODO: Implement me!
    }

    @ExceptionHandler
    public String handleException(NoSuchElementException exception) {
        return &quot;404&quot;;
    }

    private String redirectToList(Long id) {
        return String.format(&quot;redirect:/list/%d&quot;, id);
    }
}
</code></pre>
<p>Update the test cases for <code>TodoListController</code> in the test code:</p>
<pre><code class="language-java">import com.example.sitodo.model.TodoItem;
import com.example.sitodo.model.TodoList;
import com.example.sitodo.service.TodoListService;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Tag;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.test.web.servlet.MockMvc;

import java.util.List;
import java.util.NoSuchElementException;

import static java.nio.charset.StandardCharsets.UTF_8;
import static org.hamcrest.Matchers.*;
import static org.mockito.ArgumentMatchers.anyBoolean;
import static org.mockito.ArgumentMatchers.anyLong;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;
import static org.springframework.http.MediaType.TEXT_HTML;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@WebMvcTest(TodoListController.class)
class TodoListControllerTest {

    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private TodoListService todoListService;

    @Test
    @DisplayName(&quot;HTTP GET '/list' retrieves list view&quot;)
    void showList_resolvesToIndex() throws Exception {
        mockMvc.perform(get(&quot;/list&quot;)).andExpectAll(
            status().isOk(),
            content().contentTypeCompatibleWith(TEXT_HTML),
            content().encoding(UTF_8),
            view().name(&quot;list&quot;)
        );
    }

    @Test
    @DisplayName(&quot;HTTP GET '/list' returns an HTML page&quot;)
    void showList_returnsHtml() throws Exception {
        mockMvc.perform(get(&quot;/list&quot;)).andExpectAll(
            status().isOk(),
            content().contentTypeCompatibleWith(TEXT_HTML),
            content().encoding(UTF_8),
            content().string(containsString(&quot;&lt;/html&gt;&quot;))
        );
    }

    @Test
    @DisplayName(&quot;HTTP GET '/list/{id}' returns an HTML page with non-empty list&quot;)
    void showList_byId_returnsHtml() throws Exception {
        TodoItem mockTodoItem = createMockTodoItem(1L, &quot;Buy milk&quot;);
        TodoList mockList = mock(TodoList.class);
        when(mockList.getId()).thenReturn(1L);
        when(mockList.getItems()).thenReturn(List.of(mockTodoItem));
        when(todoListService.getTodoListById(anyLong())).thenReturn(mockList);

        mockMvc.perform(get(&quot;/list/1&quot;)).andExpectAll(
            status().isOk(),
            content().contentTypeCompatibleWith(TEXT_HTML),
            content().encoding(UTF_8),
            content().string(containsString(&quot;&lt;table&quot;)),
            content().string(containsString(&quot;&lt;tr&quot;)),
            content().string(containsString(&quot;Buy milk&quot;)),
            content().string(containsString(&quot;&lt;/html&gt;&quot;))
        );
    }

    @Test
    @DisplayName(&quot;Suppose the given ID does not exist, HTTP GET '/list/{id}' returns an error page&quot;)
    void showList_byId_notFound() throws Exception {
        when(todoListService.getTodoListById(anyLong())).thenThrow(NoSuchElementException.class);

        mockMvc.perform(get(&quot;/list/1&quot;)).andExpectAll(
            content().string(containsString(&quot;Not Found&quot;))
        );
    }

    @Test
    @DisplayName(&quot;HTTP GET '/list/{id}/update/{item_id}' successfully updated status of an item&quot;)
    void updateItem_ok() throws Exception {
        // TODO: Implement me!
    }

    private TodoList createMockTodoList(Long id, TodoItem ... items) {
        TodoList mockTodoList = mock(TodoList.class);

        when(mockTodoList.getId()).thenReturn(id);
        when(mockTodoList.getItems()).thenReturn(List.of(items));

        return mockTodoList;
    }

    private TodoItem createMockTodoItem(Long id, String title) {
        TodoItem mockTodoItem = mock(TodoItem.class);

        when(mockTodoItem.getId()).thenReturn(id);
        when(mockTodoItem.getTitle()).thenReturn(title);
        when(mockTodoItem.getFinished()).thenCallRealMethod();

        return mockTodoItem;
    }
}
</code></pre>
<p>Similar to the previous layer, there are some TODO comments and method need to be implemented.
Please implement them as well.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../test-automation/" class="btn btn-neutral float-left" title="Test Automation"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../test-automation/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme_extra.js" defer></script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
